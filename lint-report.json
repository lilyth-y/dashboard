[{"filePath":"C:\\startup\\dashboard\\components\\kokonutui\\transaction-form.tsx","messages":[{"ruleId":"import/order","severity":1,"message":"There should be no empty line within import group","line":13,"column":1,"nodeType":"ImportDeclaration","endLine":13,"endColumn":52,"fix":{"range":[643,645],"text":""}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { useForm } from \"react-hook-form\"\r\n\r\nimport { Alert, AlertDescription } from \"@/components/ui/alert\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\n\r\nimport { uploadAndEnqueueProjectDocument } from \"@/lib/documents-client\"\r\n\r\n\r\ninterface TransactionFormData {\r\n  amount: number\r\n  type: 'INCOME' | 'EXPENSE'\r\n  category: string\r\n  description: string\r\n  date: string\r\n  projectId?: string\r\n}\r\n\r\ninterface Project {\r\n  id: string\r\n  name: string\r\n}\r\n\r\nconst incomeCategories = [\r\n  { value: 'SALES', label: '매출' },\r\n  { value: 'CONSULTING', label: '컨설팅' },\r\n  { value: 'INVESTMENT', label: '투자 수익' },\r\n  { value: 'OTHER_INCOME', label: '기타 수입' },\r\n]\r\n\r\nconst expenseCategories = [\r\n  { value: 'SALARY', label: '급여' },\r\n  { value: 'OFFICE_SUPPLIES', label: '사무용품' },\r\n  { value: 'MARKETING', label: '마케팅' },\r\n  { value: 'RENT', label: '임대료' },\r\n  { value: 'UTILITIES', label: '공과금' },\r\n  { value: 'TRAVEL', label: '출장비' },\r\n  { value: 'SOFTWARE', label: '소프트웨어' },\r\n  { value: 'EQUIPMENT', label: '장비' },\r\n  { value: 'TAX', label: '세금' },\r\n  { value: 'OTHER_EXPENSE', label: '기타 지출' },\r\n]\r\n\r\ninterface TransactionFormProps {\r\n  onSuccess?: () => void\r\n}\r\n\r\nexport default function TransactionForm({ onSuccess }: TransactionFormProps) {\r\n  const [loading, setLoading] = useState(false)\r\n  const [uploadingReceipt, setUploadingReceipt] = useState(false)\r\n  const [message, setMessage] = useState<{ type: 'success' | 'error', text: string } | null>(null)\r\n  const [projects, setProjects] = useState<Project[]>([])\r\n  const [transactionType, setTransactionType] = useState<'INCOME' | 'EXPENSE'>('EXPENSE')\r\n  const [receiptDocumentId, setReceiptDocumentId] = useState<string | null>(null)\r\n\r\n  const {\r\n    register,\r\n    handleSubmit,\r\n    reset,\r\n    setValue,\r\n    watch,\r\n    formState: { errors }\r\n  } = useForm<TransactionFormData>({\r\n    defaultValues: {\r\n      type: 'EXPENSE',\r\n      date: new Date().toISOString().split('T')[0]\r\n    }\r\n  })\r\n\r\n  const selectedProjectId = watch('projectId')\r\n\r\n  useEffect(() => {\r\n    // 프로젝트 목록 가져오기\r\n    const fetchProjects = async () => {\r\n      try {\r\n        const response = await fetch('/api/projects')\r\n        if (response.ok) {\r\n          const data = await response.json()\r\n          setProjects(data.projects || [])\r\n        }\r\n      } catch (error) {\r\n        console.error('프로젝트 목록 로딩 실패:', error)\r\n      }\r\n    }\r\n\r\n    fetchProjects()\r\n  }, [])\r\n\r\n  const onSubmit = async (data: TransactionFormData) => {\r\n    setLoading(true)\r\n    setMessage(null)\r\n\r\n    try {\r\n      const response = await fetch('/api/financial/transactions', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify({\r\n          ...data,\r\n          type: transactionType,\r\n        }),\r\n      })\r\n\r\n      if (response.ok) {\r\n        setMessage({ type: 'success', text: '거래가 성공적으로 등록되었습니다.' })\r\n        setReceiptDocumentId(null)\r\n        reset({\r\n          amount: 0,\r\n          type: transactionType,\r\n          category: '',\r\n          description: '',\r\n          date: new Date().toISOString().split('T')[0],\r\n          projectId: ''\r\n        })\r\n        onSuccess?.()\r\n      } else {\r\n        const errorData = await response.json()\r\n        setMessage({ type: 'error', text: errorData.error || '거래 등록에 실패했습니다.' })\r\n      }\r\n    } catch (error: unknown) {\r\n      console.error('Transaction form error:', error)\r\n      setMessage({ type: 'error', text: '네트워크 오류가 발생했습니다.' })\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const onReceiptChange = async (file: File | null) => {\r\n    if (!file) return\r\n\r\n    // Documents are project-scoped.\r\n    if (!selectedProjectId) {\r\n      setMessage({ type: 'error', text: '영수증/문서를 첨부하려면 프로젝트를 먼저 선택해주세요.' })\r\n      return\r\n    }\r\n\r\n    setUploadingReceipt(true)\r\n    setMessage(null)\r\n\r\n    try {\r\n      const { documentId } = await uploadAndEnqueueProjectDocument({\r\n        projectId: selectedProjectId,\r\n        file,\r\n      })\r\n\r\n      setReceiptDocumentId(documentId)\r\n      setMessage({ type: 'success', text: '영수증/문서가 업로드되었습니다. OCR 처리 중입니다.' })\r\n    } catch (error: unknown) {\r\n      console.error('Receipt upload error:', error)\r\n      setMessage({ type: 'error', text: error instanceof Error ? error.message : '영수증/문서 업로드에 실패했습니다.' })\r\n    } finally {\r\n      setUploadingReceipt(false)\r\n    }\r\n  }\r\n\r\n  const currentCategories = transactionType === 'INCOME' ? incomeCategories : expenseCategories\r\n\r\n  return (\r\n    <Card>\r\n      <CardHeader>\r\n        <CardTitle>거래 등록</CardTitle>\r\n        <CardDescription>새로운 수입 또는 지출을 등록하세요</CardDescription>\r\n      </CardHeader>\r\n      <CardContent>\r\n        {message && (\r\n          <Alert className={`mb-4 ${message.type === 'success' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>\r\n            <AlertDescription className={message.type === 'success' ? 'text-green-700' : 'text-red-700'}>\r\n              {message.text}\r\n            </AlertDescription>\r\n          </Alert>\r\n        )}\r\n\r\n  <form data-testid=\"transaction-form\" onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\r\n          {/* 거래 유형 */}\r\n          <div className=\"space-y-2\">\r\n            <Label>거래 유형</Label>\r\n            <RadioGroup\r\n              value={transactionType}\r\n              onValueChange={(value) => {\r\n                setTransactionType(value as 'INCOME' | 'EXPENSE')\r\n                setValue('category', '') // 카테고리 리셋\r\n              }}\r\n              className=\"flex space-x-4\"\r\n            >\r\n              <div className=\"flex items-center space-x-2\">\r\n                <RadioGroupItem value=\"INCOME\" id=\"income\" />\r\n                <Label htmlFor=\"income\" className=\"text-green-600 font-medium\">수입</Label>\r\n              </div>\r\n              <div className=\"flex items-center space-x-2\">\r\n                <RadioGroupItem value=\"EXPENSE\" id=\"expense\" />\r\n                <Label htmlFor=\"expense\" className=\"text-red-600 font-medium\">지출</Label>\r\n              </div>\r\n            </RadioGroup>\r\n          </div>\r\n\r\n          {/* 금액 */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"amount\">금액 *</Label>\r\n            <Input\r\n              id=\"amount\"\r\n              type=\"number\"\r\n              placeholder=\"금액을 입력하세요\"\r\n              {...register('amount', { \r\n                required: '금액을 입력해주세요',\r\n                min: { value: 1, message: '1원 이상 입력해주세요' }\r\n              })}\r\n            />\r\n            {errors.amount && (\r\n              <p className=\"text-sm text-red-600\">{errors.amount.message}</p>\r\n            )}\r\n          </div>\r\n\r\n          {/* 카테고리 */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"category\">카테고리 *</Label>\r\n            <Select onValueChange={(value) => setValue('category', value)}>\r\n              <SelectTrigger>\r\n                <SelectValue placeholder=\"카테고리를 선택하세요\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                {currentCategories.map((category) => (\r\n                  <SelectItem key={category.value} value={category.value}>\r\n                    {category.label}\r\n                  </SelectItem>\r\n                ))}\r\n              </SelectContent>\r\n            </Select>\r\n            {errors.category && (\r\n              <p className=\"text-sm text-red-600\">{errors.category.message}</p>\r\n            )}\r\n          </div>\r\n\r\n          {/* 설명 */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"description\">설명</Label>\r\n            <Textarea\r\n              id=\"description\"\r\n              placeholder=\"거래 내용을 설명하세요\"\r\n              rows={3}\r\n              {...register('description')}\r\n            />\r\n          </div>\r\n\r\n          {/* 날짜 */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"date\">날짜 *</Label>\r\n            <Input\r\n              id=\"date\"\r\n              type=\"date\"\r\n              {...register('date', { required: '날짜를 선택해주세요' })}\r\n            />\r\n            {errors.date && (\r\n              <p className=\"text-sm text-red-600\">{errors.date.message}</p>\r\n            )}\r\n          </div>\r\n\r\n          {/* 프로젝트 (선택사항) */}\r\n          {projects.length > 0 && (\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"project\">프로젝트 (선택사항)</Label>\r\n              <Select onValueChange={(value) => setValue('projectId', value === 'none' ? undefined : value)}>\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"프로젝트를 선택하세요\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"none\">프로젝트 없음</SelectItem>\r\n                  {projects.map((project) => (\r\n                    <SelectItem key={project.id} value={project.id}>\r\n                      {project.name}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n          )}\r\n\r\n          {/* 영수증/문서 첨부 (선택사항) */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"receipt\">영수증/문서 첨부 (선택사항)</Label>\r\n            <Input\r\n              id=\"receipt\"\r\n              type=\"file\"\r\n              accept=\"image/*,application/pdf\"\r\n              disabled={uploadingReceipt}\r\n              onChange={(e) => {\r\n                const f = e.currentTarget.files?.[0] ?? null\r\n                void onReceiptChange(f)\r\n              }}\r\n            />\r\n            {receiptDocumentId && (\r\n              <p className=\"text-sm text-muted-foreground\">문서 ID: {receiptDocumentId}</p>\r\n            )}\r\n          </div>\r\n\r\n          <Button type=\"submit\" disabled={loading} className=\"w-full\">\r\n            {loading ? '등록 중...' : '거래 등록'}\r\n          </Button>\r\n        </form>\r\n      </CardContent>\r\n    </Card>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\startup\\dashboard\\lib\\documents-client.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":34,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[911,914],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[911,914],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":35,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[955,958],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[955,958],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":69,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1898,1901],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1898,1901],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export type UploadUrlResponse = {\r\n  documentId: string\r\n  upload: {\r\n    url: string\r\n    headers: Record<string, string>\r\n    expiresAt: string\r\n  }\r\n  gcs: {\r\n    bucket: string\r\n    objectKey: string\r\n    uri: string\r\n  }\r\n}\r\n\r\nexport async function requestProjectDocumentUploadUrl(input: {\r\n  projectId: string\r\n  filename: string\r\n  contentType: string\r\n  sizeBytes?: number\r\n}): Promise<UploadUrlResponse> {\r\n  const res = await fetch(`/api/projects/${encodeURIComponent(input.projectId)}/documents/upload-url`, {\r\n    method: \"POST\",\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify({\r\n      filename: input.filename,\r\n      contentType: input.contentType,\r\n      sizeBytes: input.sizeBytes,\r\n    }),\r\n  })\r\n\r\n  const data = (await res.json()) as unknown\r\n  if (!res.ok) {\r\n    const message =\r\n      typeof data === \"object\" && data && \"error\" in data && typeof (data as any).error === \"string\"\r\n        ? (data as any).error\r\n        : \"Upload URL request failed\"\r\n    throw new Error(message)\r\n  }\r\n\r\n  return data as UploadUrlResponse\r\n}\r\n\r\nexport async function uploadFileToSignedUrl(input: {\r\n  url: string\r\n  headers: Record<string, string>\r\n  file: File\r\n}): Promise<void> {\r\n  const res = await fetch(input.url, {\r\n    method: \"PUT\",\r\n    headers: {\r\n      ...input.headers,\r\n      // Some browsers may not set content-type automatically for PUT\r\n      \"Content-Type\": input.file.type || input.headers[\"content-type\"] || \"application/octet-stream\",\r\n    },\r\n    body: input.file,\r\n  })\r\n\r\n  if (!res.ok) {\r\n    throw new Error(`Upload failed (${res.status})`)\r\n  }\r\n}\r\n\r\nexport async function enqueueDocumentProcessing(documentId: string): Promise<void> {\r\n  const res = await fetch(`/api/documents/${encodeURIComponent(documentId)}/enqueue`, {\r\n    method: \"POST\",\r\n  })\r\n\r\n  if (!res.ok) {\r\n    const data = (await res.json().catch(() => null)) as any\r\n    const message = data?.error || `Enqueue failed (${res.status})`\r\n    throw new Error(message)\r\n  }\r\n}\r\n\r\nexport async function uploadAndEnqueueProjectDocument(input: {\r\n  projectId: string\r\n  file: File\r\n}): Promise<{ documentId: string }> {\r\n  const upload = await requestProjectDocumentUploadUrl({\r\n    projectId: input.projectId,\r\n    filename: input.file.name,\r\n    contentType: input.file.type || \"application/octet-stream\",\r\n    sizeBytes: input.file.size,\r\n  })\r\n\r\n  await uploadFileToSignedUrl({\r\n    url: upload.upload.url,\r\n    headers: upload.upload.headers,\r\n    file: input.file,\r\n  })\r\n\r\n  await enqueueDocumentProcessing(upload.documentId)\r\n\r\n  return { documentId: upload.documentId }\r\n}\r\n","usedDeprecatedRules":[]}]